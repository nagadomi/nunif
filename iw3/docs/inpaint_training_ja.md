# インペイントのモデル学習

本ドキュメントでは、インペイントモデルの学習手順について詳述します。学習プロセスは大きく2つのフェーズに分かれています。

1. **学習データの生成**（`create_training_data.py`）
2. **モデルの学習**（`train.py`）

**フェーズ1**では、用意した画像または動画から学習用データセットを生成します。  
**フェーズ2**では、フェーズ1で作成したデータを用いてインペイントモデルの学習を実施します。

## 開発用モジュールのインストール

最初に開発用のモジュールをインストールします。

```
python -m pip install -r requirements-dev.txt
```
Windowsの場合は、`nunif-prompt.bat`から実行してください。

## 画像用モデルと動画用モデルの違い

画像用と動画用インペイントモデルは、それぞれ異なるデータ形式およびモデルアーキテクチャを採用しています。共通する部分もありますが、基本的には別々のものとして扱ってください。
動画のみを対象とする場合、画像用モデルの学習は不要です。

各手順については、以下のリンクを参照してください。

- [動画用インペイントモデルの学習](./inpaint_training_video_ja.md)
- [画像用インペイントモデルの学習](./inpaint_training_image_ja.md)

## 学習データの生成手法

学習データ生成では、通常の2D画像からインペイント用のマスクを生成します。

- **入力データ（X）**: マスク領域を隠した画像
- **正解データ（Y）**: 元画像

マスクはランダムではなく、Forward warpingによる欠損領域（穴）を模して生成します。

### マスク生成の手順（右ビューの場合）

1. 深度マップを基に、元画像の深度マップを**左**ビュー用にワープ
2. 左ビュー用にワープした深度マップに従い、空のテンソルを**右**ビュー用にワープ
3. 元画像上に、forward warpingによる欠損領域が生成される
4. 生成された欠損領域をクロージング処理で補完

左ビュー用にワープした画像を同条件で右ビュー用にワープさせると元画像の位置に戻るという性質を活用し、元画像に対する欠損領域を生成します。元画像にはワープによる歪みや欠損がないため、正解データ（Ground Truth）として利用可能です。

Forward warpingによる欠損領域を生成することで、以下のようなドメイン知識をモデルに組み込むことができます。

- マスクは前景と背景の境界に沿って発生する
- マスクは背景によって補完される
- 右ビューでは、マスクの右側が背景、左側が前景となる

これにより、現実的なインペイントタスクを模擬した学習データを通常の画像から作成できます。

<img width="320" height="320" alt="mask-example" src="https://github.com/user-attachments/assets/12a02a8e-e73c-4aea-97b1-e054d1fe92d7" />

